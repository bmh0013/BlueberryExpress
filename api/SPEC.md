# API Specifications

_NOTE: this document is a work in progress, and the API specifications may change as application requirements change_

#### CONTENTS

- [Overview](#1-overview)
- [Authentication](#2-authentication)
  - [Authentication Process](#21-authentication-process)
  - [JWT Structure](#22-jwt-structure)
- [Users](#3-users-users)
  - [Availability](#31-availability)
    - [GET `/users/{userId}/availability](#get-usersuseridavailability)
- [Appointments](#4-appointments-appointments)

## 1. Overview

This API is not public facing, and will only be exposed on a local network to the front-end code.
This document is intended for use by those developing the API and/or the front-end code that needs to consume the API, as such, it is more technical in nature than many would expect.

All API responses will be sent as JSON documents, with the specific structure of the document specified under a specific endpoint

Currently, the API requires a valid JWT token to be sent as a cookie with any given request.

## 2. Authentication

Authentication of users on Blueberry Express is currently limited solely to OAuth2.0 authentication via google's services. This design choice has implications on how authentication routes are handled from the API server.

As of right now, in order to have a valid JWT token, a request to `/auth/google` needs to be made, from a browser window, to generate the expected token. This process is still very much a work in progress, and this document will be updated accordingly when more information becomes available.

**IMPORTANT NOTE: THE AUTHORIZATION PROCESS IS NOT SET IN STONE AT THE MOMENT. WE ARE CURRENTLY CONSIDERING JWT TOKENS, AND ALSO THE MORE CLASSIC 'COOKIE' BASED APPROACH**

### 2.1 Authentication process

The working plan for Authenticating users is as follows:

- If no valid session is found on the first API request sent from the front-end, the server will respond with status code `403` indicating that the user must authenticate before requesting access to the API.
- At this point, the frontend should choose to display a 'login with google' button.
- Clicking this button should open a new window, with the url being the `/auth/google` endpoint.
- The user will proceed to login via google in this window, and before closing, the window will send a 'message' to the original window, containing the JWT token generated by the API server
- At this point, the user is authenticated, and can use this API.

### 2.2 JWT Structure

The working plan for the JWTs is simply as follows:

| Field         | Description                                                        |
| ------------- | ------------------------------------------------------------------ |
| id            | the user id associated with the current user, as defined by google |
| type          | Either 'student' or 'teacher'                                      |
| token         | The current authorization token from google                        |
| refresh_token | The refresh token from google                                      |

## 3. Users: '/users'

_Something of note here: You won't find an endpoint to create a user. That process is handled by the authentication system set up above. However, there are endpoints to *update* users, once authenticated._

TODO: Determine the complete structure of the 'user' endpoint

### 3.1 Availability

#### GET '/users/{userId}/availability

Returns an array of datetimes for which the specified user should be considered 'busy', either because of their availability settings or previous appointments. Times are relative to the current users' timezone, not the user being queried.

##### Parameters

Parameters should be passed as url query string parameters.

| Parameter | Description                                                                                 |
| --------- | ------------------------------------------------------------------------------------------- |
| start     | The timestamp for the start of the searched time range. Optional. Defaults to Date.now()    |
| end       | The timestamp for the end of the searched time range. Optional. Defaults to 1 week from now |

##### Response data:

| Field        | Description                                                           |
| ------------ | --------------------------------------------------------------------- |
| busy         | An array of objects, representing 'busy' times for the requested user |
| busy[].start | The start of a busy time block, as a timestamp                        |
| busy[].end   | The end of a busy time block, as a timestamp                          |
| error        | An object containing information about the error                      |

##### Example request and response:

Request:

```javascript
axios
  .get('/users/1234/availability')
  .then((response) => {
    return response.body;
  })
  .then((body) => {
    // Parse data here
  });
```

Response:

```json
{
  "busy": [
    {
      "start": 1617497295,
      "end": 1617518885
    },
    {
      "start": 1617558485,
      "end": 1617560285
    }
  ]
}
```

## 4. Appointments: `/appointments/`
